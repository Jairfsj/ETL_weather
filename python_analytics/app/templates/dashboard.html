<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå§Ô∏è Painel de Clima - Montreal</title>

    <!-- Favicon and Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå§Ô∏è</text></svg>">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Plotly.js for charts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .last-updated {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 10px;
        }

        /* Status Bar */
        .status-bar {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.error { background: #ef4444; }
        .status-dot.warning { background: #f59e0b; }

        /* Current Weather Card */
        .current-weather {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .location-info h2 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #1f2937;
        }

        .current-temp {
            font-size: 4rem;
            font-weight: 300;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feels-like {
            font-size: 1.1rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 500;
            color: #4b5563;
            margin-top: 10px;
        }

        .weather-icon {
            font-size: 3rem;
        }

        /* Weather Grid */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .weather-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #e5e7eb;
        }

        .weather-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .weather-card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #3b82f6;
        }

        .weather-card-value {
            font-size: 2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .weather-card-label {
            font-size: 0.9rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Charts */
        .chart-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
        }

        .summary-icon {
            font-size: 2rem;
            margin-right: 16px;
            width: 50px;
            text-align: center;
        }

        .summary-icon i {
            color: #3b82f6;
        }

        .summary-content {
            flex: 1;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-selector {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: rgba(255,255,255,0.8);
            padding: 20px;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 15px; }

            .header h1 { font-size: 2rem; }

            .current-temp { font-size: 3rem; }

            .weather-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .weather-card {
                padding: 15px;
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }

            .status-info {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .weather-grid {
                grid-template-columns: 1fr;
            }

            .current-temp { font-size: 2.5rem; }

            .weather-header {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                color: #e2e8f0;
            }

            .current-weather, .chart-container, .status-bar {
                background: rgba(30, 41, 59, 0.9);
                border: 1px solid rgba(71, 85, 105, 0.2);
            }

            .weather-card {
                background: #1e293b;
                border-color: #374151;
            }

            .weather-card-value, .location-info h2, .chart-title {
                color: #f1f5f9;
            }

            .weather-card-label, .feels-like {
                color: #94a3b8;
            }
        }
    </style>
  </head>
  <body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-cloud-sun"></i> Montreal Weather Dashboard</h1>
            <p class="subtitle">Dados clim√°ticos em tempo real da cidade de Montreal</p>
            <div class="last-updated" id="last-updated">Carregando...</div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="status-bar">
            <div class="status-info">
                <div class="status-item">
                    <div class="status-dot" id="api-status"></div>
                    <span>API</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="db-status"></div>
                    <span>Banco de Dados</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span id="update-interval">Atualiza√ß√£o a cada 5 min</span>
                </div>
            </div>
            <div class="status-info">
                <button onclick="refreshData()" class="refresh-btn" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
        </div>

        <!-- Current Weather -->
        <div class="current-weather" id="current-weather">
            <div class="loading">
                <div class="spinner"></div>
                <p>Carregando dados clim√°ticos...</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Tend√™ncia de Temperatura
                </h3>
                <div class="chart-controls">
                    <select class="time-selector" id="temp-time-selector" onchange="updateCharts()">
                        <option value="6">√öltimas 6 horas</option>
                        <option value="12">√öltimas 12 horas</option>
                        <option value="24" selected>√öltimas 24 horas</option>
                        <option value="48">√öltimas 48 horas</option>
                        <option value="168">√öltima semana</option>
                    </select>
                </div>
            </div>
            <div id="temperature-chart" style="height: 300px;"></div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-tint"></i>
                    Tend√™ncia de Umidade
                </h3>
                <div class="chart-controls">
                    <select class="time-selector" id="humidity-time-selector" onchange="updateCharts()">
                        <option value="6">√öltimas 6 horas</option>
                        <option value="12">√öltimas 12 horas</option>
                        <option value="24" selected>√öltimas 24 horas</option>
                        <option value="48">√öltimas 48 horas</option>
                        <option value="168">√öltima semana</option>
                    </select>
                </div>
            </div>
            <div id="humidity-chart" style="height: 300px;"></div>
        </div>

        <!-- Additional Charts Row -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-gauge"></i>
                        Press√£o Atmosf√©rica
                    </h3>
                    <div class="chart-controls">
                        <select class="time-selector" id="pressure-time-selector" onchange="updateCharts()">
                            <option value="6">√öltimas 6 horas</option>
                            <option value="12">√öltimas 12 horas</option>
                            <option value="24" selected>√öltimas 24 horas</option>
                            <option value="48">√öltimas 48 horas</option>
                            <option value="168">√öltima semana</option>
                        </select>
                    </div>
                </div>
                <div id="pressure-chart" style="height: 250px;"></div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-wind"></i>
                        Velocidade do Vento
                    </h3>
                    <div class="chart-controls">
                        <select class="time-selector" id="wind-time-selector" onchange="updateCharts()">
                            <option value="6">√öltimas 6 horas</option>
                            <option value="12">√öltimas 12 horas</option>
                            <option value="24" selected>√öltimas 24 horas</option>
                            <option value="48">√öltimas 48 horas</option>
                            <option value="168">√öltima semana</option>
                        </select>
                    </div>
                </div>
                <div id="wind-chart" style="height: 250px;"></div>
            </div>
        </div>

        <!-- Temperature vs Feels Like Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-temperature-half"></i>
                    Temperatura vs Sensa√ß√£o T√©rmica
                </h3>
                <div class="chart-controls">
                    <select class="time-selector" id="feels-like-time-selector" onchange="updateCharts()">
                        <option value="6">√öltimas 6 horas</option>
                        <option value="12">√öltimas 12 horas</option>
                        <option value="24" selected>√öltimas 24 horas</option>
                        <option value="48">√öltimas 48 horas</option>
                        <option value="168">√öltima semana</option>
                    </select>
                </div>
            </div>
            <div id="feels-like-chart" style="height: 300px;"></div>
        </div>

        <!-- Weather Conditions Summary Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Distribui√ß√£o de Condi√ß√µes Clim√°ticas
                </h3>
                <div class="chart-controls">
                    <select class="time-selector" id="conditions-time-selector" onchange="updateCharts()">
                        <option value="24" selected>√öltimas 24 horas</option>
                        <option value="48">√öltimas 48 horas</option>
                        <option value="168">√öltima semana</option>
                        <option value="720">√öltimo m√™s</option>
                    </select>
                </div>
            </div>
            <div id="conditions-chart" style="height: 300px;"></div>
        </div>

        <!-- Daily Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="temp-min">--¬∞C</div>
                    <div class="summary-label">Temperatura M√≠nima</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-temperature-high"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="temp-max">--¬∞C</div>
                    <div class="summary-label">Temperatura M√°xima</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="humidity-avg">--%</div>
                    <div class="summary-label">Umidade M√©dia</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-wind"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="wind-avg">-- km/h</div>
                    <div class="summary-label">Vento M√©dio</div>
                </div>
            </div>
        </div>
    </div>

    <!-- AerisWeather Section -->
    <div class="aeris-section" style="margin: 40px 0;">
        <div class="section-header" style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: white; font-size: 2rem; margin-bottom: 10px;">
                <i class="fas fa-satellite-dish"></i> Dados AerisWeather
            </h2>
            <p style="color: #e5e7eb; font-size: 1.1rem;">Informa√ß√µes complementares do clima de Montreal</p>
        </div>

        <div class="aeris-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <!-- AerisWeather Data Card -->
            <div class="card" style="background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 24px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);">
                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                    <i class="fas fa-cloud-sun" style="font-size: 1.5rem; color: #3b82f6; margin-right: 12px;"></i>
                    <h3 style="margin: 0; color: #1f2937; font-size: 1.25rem;">Clima Atual (AerisWeather)</h3>
                </div>
                <div id="aeris-weather-data">
                    <div class="loading" style="text-align: center; padding: 20px;">
                        <div class="spinner" style="border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; margin-bottom: 10px;"></div>
                        <p style="color: #6b7280; margin: 0;">Carregando dados AerisWeather...</p>
                    </div>
                </div>
            </div>

            <!-- AerisWeather Actions Card -->
            <div class="card" style="background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 24px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);">
                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                    <i class="fas fa-download" style="font-size: 1.5rem; color: #10b981; margin-right: 12px;"></i>
                    <h3 style="margin: 0; color: #1f2937; font-size: 1.25rem;">A√ß√µes</h3>
                </div>
                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="loadAerisWeather()" class="action-btn" style="padding: 12px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;">
                        <i class="fas fa-sync-alt"></i> Carregar Dados AerisWeather
                    </button>
                    <button onclick="downloadAerisCSV()" class="action-btn" style="padding: 12px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;">
                        <i class="fas fa-file-csv"></i> Baixar CSV
                    </button>
                    <button onclick="compareSources()" class="action-btn" style="padding: 12px 16px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;">
                        <i class="fas fa-balance-scale"></i> Comparar Fontes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>Dashboard de Clima Montreal v1.0.0 | Dados fornecidos por OpenWeatherMap & AerisWeather</p>
    </div>

  <script>
        let weatherData = [];
        let currentWeather = null;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setInterval(loadData, 5 * 60 * 1000); // Refresh every 5 minutes
        });

        async function loadData() {
            try {
                // Load current weather and recent data
                const [currentResponse, latestResponse] = await Promise.all([
                    fetch('/api/v1/weather/current'),
                    fetch('/api/v1/weather/latest?limit=100')
                ]);

                const currentResult = await currentResponse.json();
                const latestResult = await latestResponse.json();

                if (currentResult.success && latestResult.success) {
                    currentWeather = currentResult.data;
                    weatherData = latestResult.data;

                    updateUI();
                    updateStatus('success');
                } else {
                    throw new Error('Failed to load weather data');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('error');
                showError('Erro ao carregar dados clim√°ticos. Tente novamente em alguns minutos.');
            }
        }

        function updateUI() {
            updateCurrentWeather();
            updateCharts();
            updateLastUpdated();
        }

        function updateCurrentWeather() {
            if (!currentWeather) return;

            const weatherHtml = `
                <div class="weather-header">
                    <div class="location-info">
                        <h2><i class="fas fa-map-marker-alt"></i> ${currentWeather.city}</h2>
                        <div class="weather-main">
                            <span class="weather-icon">${getWeatherIcon(currentWeather.weather_main)}</span>
                            <span>${currentWeather.weather_main} - ${currentWeather.weather_description}</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="current-temp">${currentWeather.temperature}¬∞C</div>
                        <div class="feels-like">Sensa√ß√£o t√©rmica: ${currentWeather.feels_like}¬∞C</div>
                    </div>
                </div>

                <div class="weather-grid">
                    <div class="weather-card">
                        <div class="weather-card-icon"><i class="fas fa-thermometer-half"></i></div>
                        <div class="weather-card-value">${currentWeather.temperature}¬∞C</div>
                        <div class="weather-card-label">Temperatura</div>
                    </div>

                    <div class="weather-card">
                        <div class="weather-card-icon"><i class="fas fa-temperature-high"></i></div>
                        <div class="weather-card-value">${currentWeather.feels_like}¬∞C</div>
                        <div class="weather-card-label">Sensa√ß√£o T√©rmica</div>
                    </div>

                    <div class="weather-card">
                        <div class="weather-card-icon"><i class="fas fa-tint"></i></div>
                        <div class="weather-card-value">${currentWeather.humidity}%</div>
                        <div class="weather-card-label">Umidade</div>
                    </div>

                    <div class="weather-card">
                        <div class="weather-card-icon"><i class="fas fa-wind"></i></div>
                        <div class="weather-card-value">${currentWeather.wind_speed}</div>
                        <div class="weather-card-label">Velocidade do Vento (km/h)</div>
                    </div>

                    <div class="weather-card">
                        <div class="weather-card-icon"><i class="fas fa-gauge"></i></div>
                        <div class="weather-card-value">${currentWeather.pressure}</div>
                        <div class="weather-card-label">Press√£o (hPa)</div>
                    </div>

                    <div class="weather-card">
                        <div class="weather-card-icon"><i class="fas fa-cloud"></i></div>
                        <div class="weather-card-value">${currentWeather.weather_main}</div>
                        <div class="weather-card-label">${currentWeather.weather_description}</div>
                    </div>
                </div>
            `;

            document.getElementById('current-weather').innerHTML = weatherHtml;
        }

        function updateCharts() {
            const tempHours = parseInt(document.getElementById('temp-time-selector').value);
            const humidityHours = parseInt(document.getElementById('humidity-time-selector').value);
            const pressureHours = parseInt(document.getElementById('pressure-time-selector').value);
            const windHours = parseInt(document.getElementById('wind-time-selector').value);
            const feelsLikeHours = parseInt(document.getElementById('feels-like-time-selector').value);
            const conditionsHours = parseInt(document.getElementById('conditions-time-selector').value);

            updateTemperatureChart(tempHours);
            updateHumidityChart(humidityHours);
            updatePressureChart(pressureHours);
            updateWindChart(windHours);
            updateFeelsLikeChart(feelsLikeHours);
            updateConditionsChart(conditionsHours);
            updateSummaryCards();
        }

        function updateTemperatureChart(hours) {
            const filteredData = filterDataByHours(weatherData, hours);

            if (filteredData.length === 0) return;

            const trace = {
                x: filteredData.map(d => new Date(d.timestamp * 1000)),
                y: filteredData.map(d => d.temperature),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Temperatura (¬∞C)',
                line: {color: '#ef4444', width: 3},
                marker: {color: '#ef4444', size: 6}
            };

            const layout = {
                margin: {l: 60, r: 30, t: 20, b: 60},
                xaxis: {
                    title: 'Hor√°rio',
                    type: 'date'
                },
                yaxis: {
                    title: 'Temperatura (¬∞C)',
                    gridcolor: '#e5e7eb'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#374151'}
            };

            Plotly.newPlot('temperature-chart', [trace], layout, {responsive: true});
        }

        function updateHumidityChart(hours) {
            const filteredData = filterDataByHours(weatherData, hours);

            if (filteredData.length === 0) return;

            const trace = {
                x: filteredData.map(d => new Date(d.timestamp * 1000)),
                y: filteredData.map(d => d.humidity),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Umidade (%)',
                line: {color: '#3b82f6', width: 3},
                marker: {color: '#3b82f6', size: 6}
            };

            const layout = {
                margin: {l: 60, r: 30, t: 20, b: 60},
                xaxis: {
                    title: 'Hor√°rio',
                    type: 'date'
                },
                yaxis: {
                    title: 'Umidade (%)',
                    gridcolor: '#e5e7eb'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#374151'}
            };

            Plotly.newPlot('humidity-chart', [trace], layout, {responsive: true});
        }

        function updatePressureChart(hours) {
            const filteredData = filterDataByHours(weatherData, hours);

            if (filteredData.length === 0) return;

            const trace = {
                x: filteredData.map(d => new Date(d.timestamp * 1000)),
                y: filteredData.map(d => d.pressure),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Press√£o (hPa)',
                line: {color: '#8b5cf6', width: 3},
                marker: {color: '#8b5cf6', size: 6}
            };

            const layout = {
                margin: {l: 60, r: 30, t: 20, b: 60},
                xaxis: {
                    title: 'Hor√°rio',
                    type: 'date'
                },
                yaxis: {
                    title: 'Press√£o (hPa)',
                    gridcolor: '#e5e7eb'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#374151'}
            };

            Plotly.newPlot('pressure-chart', [trace], layout, {responsive: true});
        }

        function updateWindChart(hours) {
            const filteredData = filterDataByHours(weatherData, hours);

            if (filteredData.length === 0) return;

            const trace = {
                x: filteredData.map(d => new Date(d.timestamp * 1000)),
                y: filteredData.map(d => d.wind_speed),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Velocidade do Vento (km/h)',
                line: {color: '#10b981', width: 3},
                marker: {color: '#10b981', size: 6}
            };

            const layout = {
                margin: {l: 60, r: 30, t: 20, b: 60},
                xaxis: {
                    title: 'Hor√°rio',
                    type: 'date'
                },
                yaxis: {
                    title: 'Velocidade (km/h)',
                    gridcolor: '#e5e7eb'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#374151'}
            };

            Plotly.newPlot('wind-chart', [trace], layout, {responsive: true});
        }

        function updateFeelsLikeChart(hours) {
            const filteredData = filterDataByHours(weatherData, hours);

            if (filteredData.length === 0) return;

            const temperatureTrace = {
                x: filteredData.map(d => new Date(d.timestamp * 1000)),
                y: filteredData.map(d => d.temperature),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Temperatura Real (¬∞C)',
                line: {color: '#ef4444', width: 3},
                marker: {color: '#ef4444', size: 6}
            };

            const feelsLikeTrace = {
                x: filteredData.map(d => new Date(d.timestamp * 1000)),
                y: filteredData.map(d => d.feels_like),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Sensa√ß√£o T√©rmica (¬∞C)',
                line: {color: '#f59e0b', width: 3, dash: 'dash'},
                marker: {color: '#f59e0b', size: 6}
            };

            const layout = {
                margin: {l: 60, r: 30, t: 20, b: 60},
                xaxis: {
                    title: 'Hor√°rio',
                    type: 'date'
                },
                yaxis: {
                    title: 'Temperatura (¬∞C)',
                    gridcolor: '#e5e7eb'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#374151'}
            };

            Plotly.newPlot('feels-like-chart', [temperatureTrace, feelsLikeTrace], layout, {responsive: true});
        }

        function updateConditionsChart(hours) {
            const filteredData = filterDataByHours(weatherData, hours);

            if (filteredData.length === 0) return;

            // Count occurrences of each weather condition
            const conditionsCount = {};
            filteredData.forEach(d => {
                const condition = d.weather_main || 'Unknown';
                conditionsCount[condition] = (conditionsCount[condition] || 0) + 1;
            });

            const data = [{
                type: 'pie',
                labels: Object.keys(conditionsCount),
                values: Object.values(conditionsCount),
                marker: {
                    colors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280']
                }
            }];

            const layout = {
                margin: {l: 30, r: 30, t: 20, b: 20},
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#374151'}
            };

            Plotly.newPlot('conditions-chart', data, layout, {responsive: true});
        }

        function updateSummaryCards() {
            if (weatherData.length === 0) return;

            // Calculate statistics
            const temperatures = weatherData.map(d => d.temperature).filter(t => t !== null);
            const humidities = weatherData.map(d => d.humidity).filter(h => h !== null);
            const windSpeeds = weatherData.map(d => d.wind_speed).filter(w => w !== null);

            if (temperatures.length > 0) {
                const tempMin = Math.min(...temperatures);
                const tempMax = Math.max(...temperatures);
                document.getElementById('temp-min').textContent = `${tempMin.toFixed(1)}¬∞C`;
                document.getElementById('temp-max').textContent = `${tempMax.toFixed(1)}¬∞C`;
            }

            if (humidities.length > 0) {
                const humidityAvg = humidities.reduce((a, b) => a + b, 0) / humidities.length;
                document.getElementById('humidity-avg').textContent = `${humidityAvg.toFixed(1)}%`;
            }

            if (windSpeeds.length > 0) {
                const windAvg = windSpeeds.reduce((a, b) => a + b, 0) / windSpeeds.length;
                document.getElementById('wind-avg').textContent = `${windAvg.toFixed(1)} km/h`;
            }
        }

        function filterDataByHours(data, hours) {
            const now = Date.now() / 1000;
            const cutoff = now - (hours * 3600);
            return data.filter(d => d.timestamp >= cutoff);
        }

        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚òÅÔ∏è',
                'Rain': 'üåßÔ∏è',
                'Snow': '‚ùÑÔ∏è',
                'Thunderstorm': '‚õàÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Mist': 'üå´Ô∏è',
                'Fog': 'üå´Ô∏è'
            };
            return icons[condition] || 'üå§Ô∏è';
        }

        function updateStatus(status) {
            const apiStatus = document.getElementById('api-status');
            const dbStatus = document.getElementById('db-status');

            if (status === 'success') {
                apiStatus.className = 'status-dot';
                dbStatus.className = 'status-dot';
            } else {
                apiStatus.className = 'status-dot error';
                dbStatus.className = 'status-dot error';
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleString('pt-BR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('last-updated').textContent = `√öltima atualiza√ß√£o: ${timeString}`;
        }

        function refreshData() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
            button.disabled = true;

            loadData().finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;

            const container = document.querySelector('.current-weather');
            container.innerHTML = '';
            container.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
                loadData(); // Try to reload
            }, 10000);
        }

        // AerisWeather functions
        async function loadAerisWeather() {
            const aerisDataDiv = document.getElementById('aeris-weather-data');
            aerisDataDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner" style="border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; margin-bottom: 10px;"></div>
                    <p style="color: #6b7280; margin: 0;">Carregando dados AerisWeather...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/v1/weather/aeris/montreal');
                const data = await response.json();

                if (data.success) {
                    const weather = data.data;
                    aerisDataDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${weather.temperature_c}¬∞C</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Temperatura</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${weather.feels_like_c}¬∞C</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Sensa√ß√£o</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${weather.humidity}%</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Umidade</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">${weather.wind_speed_kph} km/h</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">Vento</div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-weight: 500; color: #1e40af;">${weather.weather || 'N/A'}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Condi√ß√£o atual</div>
                        </div>
                        <div style="margin-top: 12px; font-size: 0.75rem; color: #9ca3af; text-align: center;">
                            Fonte: AerisWeather | Atualizado: ${new Date().toLocaleString('pt-BR')}
                        </div>
                    `;
                } else {
                    aerisDataDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #dc2626;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p style="margin: 0;">Erro ao carregar dados AerisWeather</p>
                            <p style="font-size: 0.875rem; margin-top: 5px;">${data.error || 'Verifique as credenciais da API'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                aerisDataDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc2626;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p style="margin: 0;">Erro de conex√£o</p>
                        <p style="font-size: 0.875rem; margin-top: 5px;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function downloadAerisCSV() {
            try {
                const response = await fetch('/api/v1/weather/aeris/montreal/csv');
                const data = await response.json();

                if (data.success) {
                    // Show success message
                    showNotification('CSV baixado com sucesso!', 'success');
                    console.log('CSV file created:', data.file_path);
                } else {
                    showNotification('Erro ao baixar CSV: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Erro de conex√£o: ' + error.message, 'error');
            }
        }

        async function compareSources() {
            // This function would compare OpenWeatherMap and AerisWeather data
            showNotification('Compara√ß√£o de fontes em desenvolvimento', 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 16px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                animation: slideIn 0.3s ease-out;
            `;

            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };

            notification.style.backgroundColor = colors[type] || colors.info;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Handle online/offline status
        window.addEventListener('online', function() {
            updateStatus('success');
            loadData();
        });

        window.addEventListener('offline', function() {
            updateStatus('error');
        });
  </script>
  </body>
</html>
