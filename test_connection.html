<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Conex√£o - ETL Weather Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .url-link {
            background: #28a745;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px;
            font-size: 14px;
        }
        .url-link:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Conex√£o - ETL Weather Dashboard</h1>
        <p>Esta p√°gina testa a conectividade com o sistema ETL Weather (2025-2026).</p>

        <div id="status" class="status info">
            Sistema pronto para testes. Clique nos bot√µes abaixo.
        </div>

        <div class="test-section">
            <h3>üîß Testes de Conectividade</h3>
            <div class="test-grid">
                <button onclick="testAPIHealth()" id="btn-health">API Health</button>
                <button onclick="testDashboard()" id="btn-dashboard">Dashboard</button>
                <button onclick="testMonitoring()" id="btn-monitoring">Monitoramento</button>
                <button onclick="testOpenMeteo()" id="btn-openmeteo">Open-Meteo</button>
                <button onclick="clearResults()">Limpar</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üåê Links Diretos</h3>
            <a href="http://localhost:5000/dashboard" target="_blank" class="url-link">üìä Dashboard Completo</a>
            <a href="http://127.0.0.1:5000/dashboard" target="_blank" class="url-link">üìä Dashboard (127.0.0.1)</a>
            <a href="http://localhost:5000/api/v1/weather/health" target="_blank" class="url-link">üè• API Health</a>
            <a href="http://localhost:5000/api/v1/weather/monitoring/status" target="_blank" class="url-link">üìà Status Monitoramento</a>
        </div>

        <div id="results"></div>

        <div class="test-section">
            <h3>üìã Diagn√≥stico R√°pido</h3>
            <ol>
                <li><strong>Containers:</strong> <code>docker ps</code> - Verificar se est√£o rodando</li>
                <li><strong>Porta 5000:</strong> <code>netstat -tlnp | grep 5000</code> - Verificar se est√° livre</li>
                <li><strong>API Test:</strong> <code>curl http://127.0.0.1:5000/api/v1/weather/health</code></li>
                <li><strong>Firewall:</strong> Verificar se permite conex√µes na porta 5000</li>
                <li><strong>Cache:</strong> Limpar cache do navegador (Ctrl+Shift+R)</li>
                <li><strong>URLs:</strong> Testar localhost vs 127.0.0.1</li>
            </ol>

            <h4>üöÄ Iniciar Sistema:</h4>
            <pre><code>cd /home/jairfsj/ETL/ETL_weather
docker compose up -d
sleep 30
# Acessar: http://localhost:5000/dashboard</code></pre>
        </div>
    </div>

    <script>
        let resultsDiv = document.getElementById('results');
        let statusDiv = document.getElementById('status');

        function updateStatus(message, type = 'info') {
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>Status:</strong> ${message}`;
        }

        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = loading;
                button.textContent = loading ? 'Testando...' : button.textContent.replace('Testando...', '');
            }
        }

        function addResult(title, content, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${title}:</strong>\n${content}`;
            resultsDiv.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
            updateStatus('Resultados limpos. Pronto para novos testes.', 'info');
        }

        async function testAPIHealth() {
            updateStatus('Testando API Health...', 'info');
            setButtonLoading('btn-health', true);

            try {
                const response = await fetch('http://127.0.0.1:5000/api/v1/weather/health');
                const data = await response.text();

                if (response.ok) {
                    updateStatus('‚úÖ API Health: Conex√£o estabelecida!', 'success');
                    addResult('API Health', `‚úÖ Status: ${response.status}\n‚úÖ Resposta: ${data}`, 'success');
                } else {
                    updateStatus('‚ùå API Health: Resposta inv√°lida', 'error');
                    addResult('API Health Error', `‚ùå Status: ${response.status}\n‚ùå Resposta: ${data}`, 'error');
                }
            } catch (error) {
                updateStatus('‚ùå API Health: Falha de conex√£o', 'error');
                addResult('API Health Error', `‚ùå Erro: ${error.message}\nüí° Verifique se os containers est√£o rodando:\n   docker ps`, 'error');
            }

            setButtonLoading('btn-health', false);
        }

        async function testDashboard() {
            updateStatus('Testando Dashboard...', 'info');
            setButtonLoading('btn-dashboard', true);

            try {
                const response = await fetch('http://127.0.0.1:5000/dashboard');
                const data = await response.text();

                if (response.ok && data.includes('<!DOCTYPE html>')) {
                    updateStatus('‚úÖ Dashboard: Carregado com sucesso!', 'success');
                    addResult('Dashboard', `‚úÖ Status: ${response.status}\n‚úÖ HTML: ${data.length} caracteres\n‚úÖ T√≠tulo encontrado: ${data.includes('<title>')}\n\nüéâ Dashboard est√° funcionando!\nüìç URL: http://localhost:5000/dashboard`, 'success');
                } else {
                    updateStatus('‚ùå Dashboard: Resposta inv√°lida', 'error');
                    addResult('Dashboard Error', `‚ùå Status: ${response.status}\n‚ùå Conte√∫do: ${data.substring(0, 200)}...`, 'error');
                }
            } catch (error) {
                updateStatus('‚ùå Dashboard: Falha de conex√£o', 'error');
                addResult('Dashboard Error', `‚ùå Erro: ${error.message}\n\nüîß Poss√≠veis solu√ß√µes:\n1. Verificar se containers est√£o rodando\n2. Limpar cache do navegador\n3. Testar URL alternativa: http://localhost:5000/dashboard\n4. Verificar firewall na porta 5000`, 'error');
            }

            setButtonLoading('btn-dashboard', false);
        }

        async function testMonitoring() {
            updateStatus('Testando Sistema de Monitoramento...', 'info');
            setButtonLoading('btn-monitoring', true);

            try {
                const response = await fetch('http://127.0.0.1:5000/api/v1/weather/monitoring/status');
                const data = await response.text();

                if (response.ok) {
                    const jsonData = JSON.parse(data);
                    updateStatus('‚úÖ Monitoramento: Sistema ativo (2025-2026)!', 'success');
                    addResult('Sistema de Monitoramento', `‚úÖ Status: ${jsonData.status.system_status}\nüìÖ Per√≠odo: ${jsonData.status.monitoring_period}\n‚è∞ Pr√≥xima coleta: ${jsonData.status.next_monitoring_date}\nüìä Progresso: ${jsonData.status.progress_percentage}%\n\nüéØ Sistema funcionando corretamente!`, 'success');
                } else {
                    updateStatus('‚ùå Monitoramento: Sistema inativo', 'error');
                    addResult('Monitoring Error', `‚ùå Status: ${response.status}\n‚ùå Resposta: ${data}`, 'error');
                }
            } catch (error) {
                updateStatus('‚ùå Monitoramento: Falha de conex√£o', 'error');
                addResult('Monitoring Error', `‚ùå Erro: ${error.message}`, 'error');
            }

            setButtonLoading('btn-monitoring', false);
        }

        async function testOpenMeteo() {
            updateStatus('Testando Open-Meteo API...', 'info');
            setButtonLoading('btn-openmeteo', true);

            try {
                const response = await fetch('http://127.0.0.1:5000/api/v1/weather/openmeteo/long-term?years=1');
                const data = await response.text();

                if (response.ok) {
                    const jsonData = JSON.parse(data);
                    updateStatus('‚úÖ Open-Meteo: Dados hist√≥ricos dispon√≠veis!', 'success');
                    addResult('Open-Meteo API', `‚úÖ Status: ${jsonData.success}\nüìä Registros: ${jsonData.total_records}\nüìÖ Per√≠odo: ${jsonData.period}\nüå§Ô∏è Dados clim√°ticos carregados com sucesso!\n\nüí° API gratuita funcionando perfeitamente!`, 'success');
                } else {
                    updateStatus('‚ö†Ô∏è Open-Meteo: Resposta limitada (normal)', 'warning');
                    addResult('Open-Meteo Info', `‚ö†Ô∏è Status: ${response.status}\nüí° √â normal retornar erro quando n√£o h√° dados suficientes ou limite atingido.\nüìä API gratuita tem algumas limita√ß√µes.\n\n‚úÖ Infraestrutura funcionando!`, 'warning');
                }
            } catch (error) {
                updateStatus('‚ùå Open-Meteo: Falha de conex√£o', 'error');
                addResult('Open-Meteo Error', `‚ùå Erro: ${error.message}`, 'error');
            }

            setButtonLoading('btn-openmeteo', false);
        }

        // Auto-teste ao carregar
        window.addEventListener('load', function() {
            updateStatus('üß™ P√°gina de teste carregada. Sistema ETL Weather pronto!', 'success');

            // Pequeno delay antes do teste autom√°tico
            setTimeout(() => {
                testAPIHealth();
            }, 1500);
        });

        // Teste completo autom√°tico
        function runFullTest() {
            updateStatus('üîÑ Executando teste completo...', 'info');

            setTimeout(() => testAPIHealth(), 500);
            setTimeout(() => testDashboard(), 2000);
            setTimeout(() => testMonitoring(), 4000);
            setTimeout(() => testOpenMeteo(), 6000);
        }

        // Adicionar bot√£o de teste completo
        document.addEventListener('DOMContentLoaded', function() {
            const testSection = document.querySelector('.test-grid');
            const fullTestBtn = document.createElement('button');
            fullTestBtn.textContent = 'üîÑ Teste Completo';
            fullTestBtn.onclick = runFullTest;
            fullTestBtn.style.background = '#28a745';
            fullTestBtn.onmouseover = () => fullTestBtn.style.background = '#218838';
            fullTestBtn.onmouseout = () => fullTestBtn.style.background = '#28a745';
            testSection.appendChild(fullTestBtn);
        });
    </script>
</body>
</html>
