name: Python Package CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and start services
      run: |
        docker compose up -d --build postgres
        docker compose up -d --build python_analytics
        # Wait for services to be healthy
        timeout 60 bash -c 'until docker compose ps postgres | grep -q "healthy"; do sleep 2; done'
        timeout 60 bash -c 'until curl -f http://localhost:5000/api/v1/weather/health; do sleep 2; done'

    - name: Run Python tests
      run: |
        # Install pytest and run basic tests
        pip install pytest
        pytest tests/ -v

    - name: Run linting
      run: |
        # Install flake8 and run basic linting on Python files
        pip install flake8
        flake8 python_analytics/app --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 python_analytics/app --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Clean up
      run: docker compose down
