name: Python Package CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cat > .env << EOF
        POSTGRES_USER=admin
        POSTGRES_PASSWORD=admin123
        POSTGRES_DB=weatherdb
        POSTGRES_HOST=postgres
        POSTGRES_PORT=5432
        OPENWEATHER_API_KEY=demo_key
        AERIS_CLIENT_ID=demo_client_id
        AERIS_CLIENT_SECRET=demo_client_secret
        CITY=Montreal
        ETL_INTERVAL=300
        FLASK_HOST=0.0.0.0
        FLASK_PORT=5000
        RUST_LOG=info
        TELEGRAM_TOKEN=
        TELEGRAM_CHAT_ID=
        EOF

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and start services
      run: |
        docker compose up -d --build postgres
        docker compose up -d --build python_analytics
        # Wait for services to be healthy
        timeout 60 bash -c 'until docker compose ps postgres | grep -q "healthy"; do sleep 2; done'
        timeout 60 bash -c 'until curl -f http://localhost:5000/api/v1/weather/health; do sleep 2; done'

    - name: Run Python tests
      run: |
        # Install pytest and run basic tests
        pip install pytest
        pytest tests/ -v

    - name: Run linting
      run: |
        # Install flake8 and run basic linting on Python files
        pip install flake8
        flake8 python_analytics/app --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 python_analytics/app --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Clean up
      run: docker compose down
