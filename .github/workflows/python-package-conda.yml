name: Python Package CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Ensure .env file exists
      run: |
        echo "Checking .env file..."
        if [ -f .env ]; then
          echo ".env file found:"
          cat .env
        else
          echo ".env file not found, creating from repository..."
          # If .env doesn't exist, create it with default values
          cat > .env << EOF
# PostgreSQL Configuration
POSTGRES_USER=etl_user
POSTGRES_PASSWORD=supersecret
POSTGRES_DB=weather_db
POSTGRES_HOST=postgres
POSTGRES_PORT=5432

# OpenWeatherMap API
OPENWEATHER_API_KEY=demo_key

# City Configuration
CITY=Montreal

# ETL Configuration
ETL_INTERVAL=300

# Flask Configuration
FLASK_HOST=0.0.0.0
FLASK_PORT=5000

# Rust Configuration
RUST_LOG=info

# Telegram Alerts (optional)
TELEGRAM_TOKEN=
TELEGRAM_CHAT_ID=
EOF
          echo ".env file created successfully"
        fi

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and start services
      run: |
        docker compose config  # Verify docker-compose can read the configuration
        docker compose up -d --build postgres
        docker compose up -d --build python_analytics
        # Wait for services to be healthy
        timeout 60 bash -c 'until docker compose ps postgres | grep -q "healthy"; do sleep 2; done'
        timeout 60 bash -c 'until curl -f http://localhost:5000/api/v1/weather/health; do sleep 2; done'

    - name: Run Python tests
      run: |
        # Install pytest and run basic tests
        pip install pytest
        pytest tests/ -v

    - name: Run linting
      run: |
        # Install flake8 and run basic linting on Python files
        pip install flake8
        flake8 python_analytics/app --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 python_analytics/app --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Clean up
      run: docker compose down
